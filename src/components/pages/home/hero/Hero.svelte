<script lang="ts">
  import type { SanityAsset } from '@sanity/image-url/lib/types/types';
  import SanityImage from '@/lib/sanity-image.svelte';
  import H1 from '@/components/ui/H1.svelte';
  import Cta from '@/components/ui/CTA.svelte';
  import type { HeroLink } from '@/lib/types/homePage';
  import { timeline } from 'motion';
  import type { Easing } from 'motion';
  import { onMount } from 'svelte';
  import IntersectionObserver from 'svelte-intersection-observer';
  import Wavelines from './Wavelines.svelte';

  export let title: string;
  export let subtitle: string;
  export let image: SanityAsset;
  export let links: HeroLink[] | undefined = undefined;

  const delay = 0;
  const duration = 500;
  let intersecting = false;
  let waveLines2PositionX = 0;
  let mouseAnimationCanTrigger = false;
  let rootElRef: HTMLElement;
  let waveLines1DesktopRef: HTMLObjectElement;
  let waveLines2DesktopRef: HTMLObjectElement;
  let imageRef: HTMLImageElement;
  const springEasing = `cubic-bezier(0.25, 0.46, 0.45, 0.94)`;
  let easing: Easing = [0.25, 0.46, 0.45, 0.94];

  const doParallaxAnimation = (
    el: HTMLElement,
    { x = 0, y = 0 }: { x?: number; y?: number }
  ) => {
    if (el) {
      el.style.transform = `translate3d(${x}%, ${y}%, 0)`;
      el.style.transition = `transform ${duration}ms ${springEasing} ${delay}ms`;
    }
  };

  const windowScrollAction = () => {
    if (intersecting) {
      doParallaxAnimation(waveLines2DesktopRef, {
        y: waveLines2PositionX * 0.01,
      });
      doParallaxAnimation(imageRef, {
        y: waveLines2PositionX * 0.002,
      });
    }
  };

  const windowMouseMoveAction = (
    e: MouseEvent & {
      currentTarget: EventTarget & Window;
    }
  ) => {
    if (mouseAnimationCanTrigger) {
      let mousePositionX = e.clientX / window.innerWidth - 0.5;
      let mousePositionY = e.clientY / window.innerHeight - 0.5;

      doParallaxAnimation(waveLines1DesktopRef, {
        x: mousePositionX * -1.5,
        y: mousePositionY * -1.5,
      });
      doParallaxAnimation(waveLines2DesktopRef, {
        x: mousePositionX * 2.5,
        y: mousePositionY * 2.5,
      });
    }
  };
  onMount(() => {
    imageRef = document.querySelector('.hero-img') as HTMLImageElement;
    timeline(
      [
        [waveLines1DesktopRef, { x: ['-10%', 0], y: ['-10%', 0] }, { easing }],
        [imageRef, { x: ['5%', 0] }, { easing, at: 0.1 }],
        [
          waveLines2DesktopRef,
          { x: ['15%', 0], y: ['-10%', 0], opacity: [0, 1] },
          { at: 0.1, easing },
        ],
      ],
      { duration: 2 }
    );
    setTimeout(() => {
      mouseAnimationCanTrigger = true;
    }, 2000);
  });
</script>

<svelte:window
  bind:scrollY={waveLines2PositionX}
  on:scroll={windowScrollAction}
  on:mousemove={windowMouseMoveAction}
/>
<IntersectionObserver element={rootElRef} bind:intersecting>
  <section
    bind:this={rootElRef}
    class="relative lg:h-[95vh] w-full bg-blue-primary text-white bg-clip-hero-container overflow-hidden pt-[160px] lg:pt-0"
  >
    <div
      class="container lg:flex w-full lg:items-center lg:justify-center h-full relative z-10"
    >
      <div class="h-fit lg:flex-[65] xl:flex-[50]">
        <header class="space-y-[25px] max-w-xl">
          <H1>{title}</H1>
          <p class="text-[18px] leading-[28.8px]">{subtitle}</p>
        </header>

        {#if !!links?.length}
          <div
            class="flex lg:flex-row flex-col lg:space-x-[16px] mt-[75px] space-y-4 lg:space-y-0 w-full pb-[220px] lg:pb-0"
          >
            {#each links as link}
              <Cta variant={link.variant} href={link.href} title={link.title} />
            {/each}
          </div>
        {/if}
      </div>

      <div class="lg:flex-[35] xl:flex-[50] lg:block hidden" />
    </div>

    <div
      class="hidden lg:block absolute top-0 xl:left-[35%] xl:w-[65%] left-1/2 lg:w-[50%] h-full bg-clip-hero-image pointer-events-none"
    >
      <SanityImage
        class="h-full w-full object-cover hero-img"
        {image}
        maxWidth={2000}
      />
      <div class="gradient-overlay" />
    </div>

    <Wavelines bind:waveLines1DesktopRef bind:waveLines2DesktopRef />
  </section>

  <div
    class="lg:hidden relative h-full"
    style="clip-path: polygon(0 0, 100% 0%, 100% 78%, 0% 100%);"
  >
    <div
      class="absolute inset-0 h-full z-10"
      style="
      background: linear-gradient(162.22deg, #1F80F0 40px, rgba(31, 128, 240, 0) 100%);
      clip-path: polygon(0 0, 100% 0%, 100% 5%, 0 20%);"
    />
    <SanityImage class="h-full w-full object-cover " {image} maxWidth={2000} />
  </div>
</IntersectionObserver>

<style>
  .gradient-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      190deg,
      #1f80f0 15.05%,
      rgba(31, 128, 240, 0) 30.39%
    );
  }
</style>
